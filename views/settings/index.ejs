<%- include('../partials/header-standalone') %>

<div class="mb-6">
    <h3 class="text-2xl font-bold text-gray-800">System Settings</h3>
    <p class="text-gray-600 mt-1">Configure NDash and Bind DNS server settings</p>
</div>

<% if (typeof success !== 'undefined' && success) { %>
    <div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded mb-4">
        <i class="fas fa-check-circle mr-2"></i>
        <%= decodeURIComponent(success) %>
    </div>
<% } %>

<% if (typeof error !== 'undefined' && error) { %>
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
        <i class="fas fa-exclamation-circle mr-2"></i>
        <%= decodeURIComponent(error) %>
    </div>
<% } %>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Bind Configuration -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Server Information -->
        <div class="content-card">
            <div class="flex items-center justify-between mb-4">
                <h4 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-server mr-2 text-blue-600"></i>
                    Server Information
                </h4>
                <button onclick="refreshStatus()" class="btn-sm btn-primary">
                    <i class="fas fa-sync-alt mr-1" id="refresh-icon"></i>
                    Refresh
                </button>
            </div>
            
            <div class="grid grid-cols-2 gap-4" id="server-info">
                <div class="border-l-4 border-blue-500 pl-4">
                    <p class="text-sm text-gray-600">Bind Version</p>
                    <p class="text-lg font-semibold text-gray-800"><%= settings.bind.version %></p>
                </div>
                <div class="border-l-4 border-green-500 pl-4">
                    <p class="text-sm text-gray-600">Node.js Version</p>
                    <p class="text-lg font-semibold text-gray-800"><%= settings.server.nodeVersion %></p>
                </div>
                <div class="border-l-4 border-purple-500 pl-4">
                    <p class="text-sm text-gray-600">Platform</p>
                    <p class="text-lg font-semibold text-gray-800"><%= settings.server.platform %></p>
                </div>
                <div class="border-l-4 border-orange-500 pl-4">
                    <p class="text-sm text-gray-600">Uptime</p>
                    <p class="text-lg font-semibold text-gray-800"><%= Math.floor(settings.server.uptime / 60) %> minutes</p>
                </div>
            </div>
        </div>

        <!-- Bind Paths -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-folder mr-2 text-yellow-600"></i>
                Bind Configuration Paths
            </h4>
            
            <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Config Directory</p>
                        <p class="text-sm text-gray-600 font-mono"><%= settings.bind.configPath %></p>
                    </div>
                    <i class="fas fa-folder-open text-gray-400"></i>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Zones Directory</p>
                        <p class="text-sm text-gray-600 font-mono"><%= settings.bind.zonesPath %></p>
                    </div>
                    <i class="fas fa-folder-open text-gray-400"></i>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Named Conf Local</p>
                        <p class="text-sm text-gray-600 font-mono"><%= settings.bind.namedConfLocal %></p>
                    </div>
                    <i class="fas fa-file-code text-gray-400"></i>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Named Conf Options</p>
                        <p class="text-sm text-gray-600 font-mono"><%= settings.bind.namedConfOptions %></p>
                    </div>
                    <i class="fas fa-file-code text-gray-400"></i>
                </div>
            </div>
        </div>

        <!-- Zone Management Settings -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-cogs mr-2 text-indigo-600"></i>
                Zone Management Settings
            </h4>
            
            <form method="POST" action="/settings" class="space-y-4">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Auto Reload Bind</p>
                        <p class="text-xs text-gray-600">Automatically reload Bind after zone changes</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="autoReload" class="sr-only peer" <%= settings.zones.autoReload ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Validate Before Reload</p>
                        <p class="text-xs text-gray-600">Check zone syntax before reloading Bind</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="validateBeforeReload" class="sr-only peer" <%= settings.zones.validateBeforeReload ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Backup Enabled</p>
                        <p class="text-xs text-gray-600">Create backups before modifying zones</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="backupEnabled" class="sr-only peer" <%= settings.zones.backupEnabled ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Auto Generate PTR Records</p>
                        <p class="text-xs text-gray-600">Auto-create 254 PTR records for reverse zones</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="autoGeneratePTR" class="sr-only peer" <%= settings.zones.autoGeneratePTR ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="pt-4">
                    <button type="submit" class="btn btn-primary w-full" id="save-settings-btn">
                        <i class="fas fa-save mr-2"></i>
                        Save Settings
                    </button>
                </div>
            </form>
        </div>

        <!-- DNS Resolver Settings -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-globe mr-2 text-red-600"></i>
                DNS Resolver Settings
            </h4>
            
            <form method="POST" action="/settings" class="space-y-4">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Enable DNS Resolver</p>
                        <p class="text-xs text-gray-600">Allow Bind to resolve external DNS queries</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="enableResolver" class="sr-only peer" <%= settings.resolver?.enabled ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Query Logging</p>
                        <p class="text-xs text-gray-600">Log all DNS queries for analytics</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="queryLogging" class="sr-only peer" <%= settings.resolver?.queryLogging ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">DNSSEC Validation</p>
                        <p class="text-xs text-gray-600">Validate DNSSEC signatures</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="dnssecValidation" class="sr-only peer" <%= settings.resolver?.dnssecValidation !== false ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                    </label>
                </div>
                
                <div class="p-3 bg-gray-50 rounded">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cache Size</label>
                    <select name="cacheSize" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                        <option value="128M" <%= (settings.resolver?.cacheSize === '128M') ? 'selected' : '' %>>128 MB</option>
                        <option value="256M" <%= (!settings.resolver?.cacheSize || settings.resolver?.cacheSize === '256M') ? 'selected' : '' %>>256 MB</option>
                        <option value="512M" <%= (settings.resolver?.cacheSize === '512M') ? 'selected' : '' %>>512 MB</option>
                        <option value="1G" <%= (settings.resolver?.cacheSize === '1G') ? 'selected' : '' %>>1 GB</option>
                    </select>
                    <p class="text-xs text-gray-600 mt-1">DNS cache size for resolver</p>
                </div>
                
                <div class="p-3 bg-gray-50 rounded">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Forwarders</label>
                    <input type="text" name="forwarders" 
                           value="<%= settings.resolver?.forwarders ? settings.resolver.forwarders.join(', ') : '8.8.8.8, 8.8.4.4, 1.1.1.1, 1.0.0.1' %>" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                           placeholder="8.8.8.8, 8.8.4.4, 1.1.1.1, 1.0.0.1">
                    <p class="text-xs text-gray-600 mt-1">Comma-separated list of DNS forwarders</p>
                </div>
                
                <div class="pt-4">
                    <button type="submit" class="btn btn-primary w-full" id="save-resolver-btn">
                        <i class="fas fa-save mr-2"></i>
                        Save Resolver Settings
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="space-y-6">
        <!-- Bind Status -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-heartbeat mr-2 text-red-600"></i>
                Bind Status
            </h4>
            
            <div id="bind-status" class="space-y-3">
                <div class="text-center py-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="text-sm text-gray-600 mt-2">Loading status...</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-bolt mr-2 text-yellow-600"></i>
                Quick Actions
            </h4>
            
            <div class="space-y-2">
                <button onclick="reloadBind()" class="btn btn-primary w-full">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Reload Bind
                </button>
                
                <button onclick="checkConfig()" class="btn w-full">
                    <i class="fas fa-check-circle mr-2"></i>
                    Check Config
                </button>
                
                <button onclick="viewLogs()" class="btn w-full">
                    <i class="fas fa-file-alt mr-2"></i>
                    View Logs
                </button>
                
                <a href="/zones" class="btn w-full block text-center">
                    <i class="fas fa-globe mr-2"></i>
                    Manage Zones
                </a>
            </div>
        </div>

        <!-- System Info -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                About NDash
            </h4>
            
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">Version</span>
                    <span class="font-semibold">1.0.0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Server Port</span>
                    <span class="font-semibold"><%= settings.server.port %></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Repository</span>
                    <a href="https://github.com/dionipe/ndash-bind" target="_blank" class="text-blue-600 hover:underline">
                        <i class="fab fa-github mr-1"></i>GitHub
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load Bind status on page load
document.addEventListener('DOMContentLoaded', function() {
    loadBindStatus();
    
    // Add form submit handlers to show loading state
    const zoneForm = document.querySelector('form[action="/settings"]:first-of-type');
    const resolverForm = document.querySelector('form[action="/settings"]:last-of-type');
    const saveZoneBtn = document.getElementById('save-settings-btn');
    const saveResolverBtn = document.getElementById('save-resolver-btn');
    
    if (zoneForm && saveZoneBtn) {
        zoneForm.addEventListener('submit', function(e) {
            saveZoneBtn.disabled = true;
            saveZoneBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
        });
    }
    
    if (resolverForm && saveResolverBtn) {
        resolverForm.addEventListener('submit', function(e) {
            saveResolverBtn.disabled = true;
            saveResolverBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
        });
    }
    
    // Show current settings state in console
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    console.log('Current Settings State:');
    checkboxes.forEach(cb => {
        console.log(`  ${cb.name}: ${cb.checked ? 'ON' : 'OFF'}`);
    });
});

function loadBindStatus() {
    fetch('/settings/status')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('bind-status');
            if (data.success) {
                const statusColor = data.status === 'running' ? 'green' : 'red';
                const statusIcon = data.status === 'running' ? 'check-circle' : 'times-circle';
                
                statusDiv.innerHTML = `
                    <div class="text-center py-3">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-${statusColor}-100 mb-3">
                            <i class="fas fa-${statusIcon} text-3xl text-${statusColor}-600"></i>
                        </div>
                        <p class="text-lg font-semibold text-gray-800 capitalize">${data.status}</p>
                        <p class="text-xs text-gray-600 mt-1">${data.version}</p>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-exclamation-triangle text-3xl text-yellow-600 mb-2"></i>
                        <p class="text-sm text-gray-600">Failed to load status</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading status:', error);
        });
}

function refreshStatus() {
    const icon = document.getElementById('refresh-icon');
    icon.classList.add('fa-spin');
    loadBindStatus();
    setTimeout(() => icon.classList.remove('fa-spin'), 1000);
}

function reloadBind() {
    fetch('/zones/reload', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(loadBindStatus, 500);
        }
    })
    .catch(error => showNotification('Failed to reload Bind', 'error'));
}

function checkConfig() {
    showNotification('Config check feature coming soon', 'info');
}

function viewLogs() {
    showNotification('Logs viewer feature coming soon', 'info');
}

function showNotification(message, type) {
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
    };
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        info: 'fa-info-circle'
    };
    
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
    notification.innerHTML = `<i class="fas ${icons[type]} mr-2"></i>${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => notification.remove(), 500);
    }, 3000);
}
</script>

<%- include('../partials/footer-standalone') %>
