<%- include('../partials/header-standalone') %>

<div class="mb-6">
    <h3 class="text-2xl font-bold text-gray-800">System Settings</h3>
    <p class="text-gray-600 mt-1">Configure NDash and Bind DNS server settings</p>
</div>

<% if (typeof success !== 'undefined' && success) { %>
    <div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded mb-4">
        <i class="fas fa-check-circle mr-2"></i>
        <%= decodeURIComponent(success) %>
    </div>
<% } %>

<% if (typeof error !== 'undefined' && error) { %>
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
        <i class="fas fa-exclamation-circle mr-2"></i>
        <%= decodeURIComponent(error) %>
    </div>
<% } %>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Bind Configuration -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Server Information -->
        <div class="content-card">
            <div class="flex items-center justify-between mb-4">
                <h4 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-server mr-2 text-blue-600"></i>
                    Server Information
                </h4>
                <button onclick="refreshStatus()" class="btn-sm btn-primary">
                    <i class="fas fa-sync-alt mr-1" id="refresh-icon"></i>
                    Refresh
                </button>
            </div>
            
            <div class="grid grid-cols-2 gap-4" id="server-info">
                <div class="border-l-4 border-blue-500 pl-4">
                    <p class="text-sm text-gray-600">Bind Version</p>
                    <p class="text-lg font-semibold text-gray-800"><%= settings.bind.version %></p>
                </div>
                <div class="border-l-4 border-green-500 pl-4">
                    <p class="text-sm text-gray-600">Node.js Version</p>
                    <p class="text-lg font-semibold text-gray-800"><%= settings.server.nodeVersion %></p>
                </div>
                <div class="border-l-4 border-purple-500 pl-4">
                    <p class="text-sm text-gray-600">Platform</p>
                    <p class="text-lg font-semibold text-gray-800"><%= settings.server.platform %></p>
                </div>
                <div class="border-l-4 border-orange-500 pl-4">
                    <p class="text-sm text-gray-600">Uptime</p>
                    <p class="text-lg font-semibold text-gray-800"><%= Math.floor(settings.server.uptime / 60) %> minutes</p>
                </div>
            </div>
        </div>

        <!-- Bind Paths -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-folder mr-2 text-yellow-600"></i>
                Bind Configuration Paths
            </h4>
            
            <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Config Directory</p>
                        <p class="text-sm text-gray-600 font-mono"><%= settings.bind.configPath %></p>
                    </div>
                    <i class="fas fa-folder-open text-gray-400"></i>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Zones Directory</p>
                        <p class="text-sm text-gray-600 font-mono"><%= settings.bind.zonesPath %></p>
                    </div>
                    <i class="fas fa-folder-open text-gray-400"></i>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Named Conf Local</p>
                        <p class="text-sm text-gray-600 font-mono"><%= settings.bind.namedConfLocal %></p>
                    </div>
                    <i class="fas fa-file-code text-gray-400"></i>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Named Conf Options</p>
                        <p class="text-sm text-gray-600 font-mono"><%= settings.bind.namedConfOptions %></p>
                    </div>
                    <i class="fas fa-file-code text-gray-400"></i>
                </div>
            </div>
        </div>

        <!-- Zone Management Settings -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-cogs mr-2 text-indigo-600"></i>
                Zone Management Settings
            </h4>
            
            <form method="POST" action="/settings" class="space-y-4">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Auto Reload Bind</p>
                        <p class="text-xs text-gray-600">Automatically reload Bind after zone changes</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="autoReload" class="sr-only peer" <%= settings.zones.autoReload ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Validate Before Reload</p>
                        <p class="text-xs text-gray-600">Check zone syntax before reloading Bind</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="validateBeforeReload" class="sr-only peer" <%= settings.zones.validateBeforeReload ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Backup Enabled</p>
                        <p class="text-xs text-gray-600">Create backups before modifying zones</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="backupEnabled" class="sr-only peer" <%= settings.zones.backupEnabled ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Auto Generate PTR Records</p>
                        <p class="text-xs text-gray-600">Auto-create 254 PTR records for reverse zones</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="autoGeneratePTR" class="sr-only peer" <%= settings.zones.autoGeneratePTR ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="pt-4">
                    <button type="submit" class="btn btn-primary w-full" id="save-settings-btn">
                        <i class="fas fa-save mr-2"></i>
                        Save Settings
                    </button>
                </div>
            </form>
        </div>

        <!-- DNS Resolver Settings -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-globe mr-2 text-red-600"></i>
                DNS Resolver Settings
            </h4>
            
            <form method="POST" action="/settings" class="space-y-4">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Enable DNS Resolver</p>
                        <p class="text-xs text-gray-600">Allow Bind to resolve external DNS queries</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="enableResolver" class="sr-only peer" <%= settings.resolver?.enabled ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Query Logging</p>
                        <p class="text-xs text-gray-600">Log all DNS queries for analytics</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="queryLogging" class="sr-only peer" <%= settings.resolver?.queryLogging ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">DNSSEC Validation</p>
                        <p class="text-xs text-gray-600">Validate DNSSEC signatures</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="dnssecValidation" class="sr-only peer" <%= settings.resolver?.dnssecValidation !== false ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                    </label>
                </div>
                
                <div class="p-3 bg-gray-50 rounded">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cache Size</label>
                    <select name="cacheSize" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                        <option value="128M" <%= (settings.resolver?.cacheSize === '128M') ? 'selected' : '' %>>128 MB</option>
                        <option value="256M" <%= (!settings.resolver?.cacheSize || settings.resolver?.cacheSize === '256M') ? 'selected' : '' %>>256 MB</option>
                        <option value="512M" <%= (settings.resolver?.cacheSize === '512M') ? 'selected' : '' %>>512 MB</option>
                        <option value="1G" <%= (settings.resolver?.cacheSize === '1G') ? 'selected' : '' %>>1 GB</option>
                    </select>
                    <p class="text-xs text-gray-600 mt-1">DNS cache size for resolver</p>
                </div>
                
                <div class="p-3 bg-gray-50 rounded">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Forwarders</label>
                    <input type="text" name="forwarders" 
                           value="<%= settings.resolver?.forwarders ? settings.resolver.forwarders.join(', ') : '8.8.8.8, 8.8.4.4, 1.1.1.1, 1.0.0.1' %>" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                           placeholder="8.8.8.8, 8.8.4.4, 1.1.1.1, 1.0.0.1">
                    <p class="text-xs text-gray-600 mt-1">Comma-separated list of DNS forwarders</p>
                </div>

                <!-- Adblock Settings -->
                <div class="border-t pt-4 mt-4">
                    <h4 class="text-md font-semibold text-gray-800 mb-3">Adblock Settings</h4>
                    
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                            <div>
                                <p class="text-sm font-medium text-gray-700">Enable Adblock</p>
                                <p class="text-xs text-gray-600">Block ads and tracking domains</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="enableAdblock" class="sr-only peer" <%= settings.resolver?.adblock?.enabled ? 'checked' : '' %>>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                            </label>
                        </div>
                        
                        <div class="p-3 bg-gray-50 rounded">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Blocklist URLs</label>
                            <textarea name="adblockUrls" rows="3" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                                      placeholder="https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts&#10;https://p2.fqdn.im/downloads/list.txt&#10;https://example.com/blocklist.txt"><%= settings.resolver?.adblock?.blocklistUrls ? settings.resolver.adblock.blocklistUrls.join('\n') : 'https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts' %></textarea>
                            <p class="text-xs text-gray-600 mt-1">URLs to fetch adblock domain lists (one per line)</p>
                        </div>
                        
                        <div class="p-3 bg-gray-50 rounded">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Redirect To</label>
                            <input type="text" name="adblockRedirect" 
                                   value="<%= settings.resolver?.adblock?.redirectTo || '0.0.0.0' %>" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                                   placeholder="0.0.0.0">
                            <p class="text-xs text-gray-600 mt-1">IP address to redirect blocked domains to</p>
                        </div>
                        
                        <div class="p-3 bg-gray-50 rounded">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Custom Domains</label>
                            <textarea name="customAdblockDomains" rows="3" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                                      placeholder="example.com&#10;ads.domain.com&#10;tracking.site.com"><%= settings.resolver?.adblock?.customDomains ? settings.resolver.adblock.customDomains.join('\n') : '' %></textarea>
                            <p class="text-xs text-gray-600 mt-1">Additional domains to block (one per line)</p>
                        </div>
                        
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                            <div>
                                <p class="text-sm font-medium text-gray-700">Enable Wildcard Blocking</p>
                                <p class="text-xs text-gray-600">Block domains using wildcard patterns (*.example.com)</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="enableWildcardAdblock" class="sr-only peer" <%= settings.resolver?.adblock?.wildcardEnabled ? 'checked' : '' %>>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                            </label>
                        </div>
                        
                        <div class="p-3 bg-gray-50 rounded">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Wildcard Domains</label>
                            <textarea name="wildcardAdblockDomains" rows="3" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                                      placeholder="*.ads.example.com&#10;*.tracking.domain.com"><%= settings.resolver?.adblock?.wildcardDomains ? settings.resolver.adblock.wildcardDomains.join('\n') : '' %></textarea>
                            <p class="text-xs text-gray-600 mt-1">Wildcard patterns to block (one per line)</p>
                        </div>
                    </div>
                </div>

                <!-- SSL Certificate Management -->
                <div class="border-t pt-4 mt-4">
                    <h4 class="text-md font-semibold text-gray-800 mb-3">SSL Certificate Management</h4>

                    <div class="space-y-3">
                        <div class="p-3 bg-yellow-50 rounded border-l-4 border-yellow-400">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <p class="text-sm font-medium text-gray-700">SSL Certificate Status</p>
                                    <p class="text-xs text-gray-600" id="ssl-status">Loading...</p>
                                </div>
                                <button type="button" class="btn btn-secondary btn-sm" id="check-ssl-btn">
                                    <i class="fas fa-sync-alt mr-1"></i>
                                    Check Status
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Common Name</label>
                                    <input type="text" id="ssl-common-name"
                                           value="localhost"
                                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-yellow-500"
                                           placeholder="localhost">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Organization</label>
                                    <input type="text" id="ssl-organization"
                                           value="NDash DNS Server"
                                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-yellow-500"
                                           placeholder="Your Organization">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Country Code</label>
                                    <input type="text" id="ssl-country"
                                           value="US"
                                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-yellow-500"
                                           placeholder="US" maxlength="2">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Validity (Days)</label>
                                    <input type="number" id="ssl-validity"
                                           value="365"
                                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-yellow-500"
                                           min="30" max="3650">
                                </div>
                            </div>

                            <div class="mt-3 flex gap-2">
                                <button type="button" class="btn btn-success btn-sm" id="generate-ssl-btn">
                                    <i class="fas fa-certificate mr-1"></i>
                                    Generate Self-Signed SSL
                                </button>
                                <button type="button" class="btn btn-danger btn-sm" id="delete-ssl-btn" style="display: none;">
                                    <i class="fas fa-trash mr-1"></i>
                                    Delete Certificates
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DoH/DoT Settings -->
                <div class="border-t pt-4 mt-4">
                    <h4 class="text-md font-semibold text-gray-800 mb-3">Encrypted DNS Settings</h4>
                    
                    <div class="space-y-3">
                        <!-- DoH Settings -->
                        <div class="p-3 bg-blue-50 rounded border-l-4 border-blue-400">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <p class="text-sm font-medium text-gray-700">DNS over HTTPS (DoH)</p>
                                    <p class="text-xs text-gray-600">Encrypt DNS queries over HTTPS</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="enableDoH" class="sr-only peer" <%= settings.resolver?.doh?.enabled ? 'checked' : '' %>>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Port</label>
                                    <input type="number" name="dohPort" 
                                           value="<%= settings.resolver?.doh?.port || 443 %>" 
                                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                           min="1" max="65535">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Certificate Path</label>
                                    <input type="text" name="dohCertPath" 
                                           value="<%= settings.resolver?.doh?.certPath || '/etc/ssl/certs/doh.crt' %>" 
                                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                           placeholder="/path/to/cert.pem">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Private Key Path</label>
                                    <input type="text" name="dohKeyPath" 
                                           value="<%= settings.resolver?.doh?.keyPath || '/etc/ssl/private/doh.key' %>" 
                                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                           placeholder="/path/to/key.pem">
                                </div>
                            </div>
                        </div>
                        
                        <!-- DoT Settings -->
                        <div class="p-3 bg-green-50 rounded border-l-4 border-green-400">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <p class="text-sm font-medium text-gray-700">DNS over TLS (DoT)</p>
                                    <p class="text-xs text-gray-600">Encrypt DNS queries over TLS</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="enableDoT" class="sr-only peer" <%= settings.resolver?.dot?.enabled ? 'checked' : '' %>>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                </label>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Port</label>
                                    <input type="number" name="dotPort" 
                                           value="<%= settings.resolver?.dot?.port || 853 %>" 
                                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500"
                                           min="1" max="65535">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Certificate Path</label>
                                    <input type="text" name="dotCertPath" 
                                           value="<%= settings.resolver?.dot?.certPath || '/etc/ssl/certs/dot.crt' %>" 
                                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500"
                                           placeholder="/path/to/cert.pem">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Private Key Path</label>
                                    <input type="text" name="dotKeyPath" 
                                           value="<%= settings.resolver?.dot?.keyPath || '/etc/ssl/private/dot.key' %>" 
                                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500"
                                           placeholder="/path/to/key.pem">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="pt-4">
                    <button type="submit" class="btn btn-primary w-full" id="save-resolver-btn">
                        <i class="fas fa-save mr-2"></i>
                        Save Resolver Settings
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="space-y-6">
        <!-- Bind Status -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-heartbeat mr-2 text-red-600"></i>
                Bind Status
            </h4>
            
            <div id="bind-status" class="space-y-3">
                <div class="text-center py-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="text-sm text-gray-600 mt-2">Loading status...</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-bolt mr-2 text-yellow-600"></i>
                Quick Actions
            </h4>
            
            <div class="space-y-2">
                <button onclick="reloadBind()" class="btn btn-primary w-full">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Reload Bind
                </button>
                
                <button onclick="checkConfig()" class="btn w-full">
                    <i class="fas fa-check-circle mr-2"></i>
                    Check Config
                </button>
                
                <button onclick="viewLogs()" class="btn w-full">
                    <i class="fas fa-file-alt mr-2"></i>
                    View Logs
                </button>
                
                <a href="/zones" class="btn w-full block text-center">
                    <i class="fas fa-globe mr-2"></i>
                    Manage Zones
                </a>
            </div>
        </div>

        <!-- System Info -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                About NDash
            </h4>
            
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">Version</span>
                    <span class="font-semibold">1.0.0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Server Port</span>
                    <span class="font-semibold"><%= settings.server.port %></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Repository</span>
                    <a href="https://github.com/dionipe/ndash-bind" target="_blank" class="text-blue-600 hover:underline">
                        <i class="fab fa-github mr-1"></i>GitHub
                    </a>
                </div>
            </div>
        <!-- SSL Certificate Management -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-certificate mr-2 text-green-600"></i>
                SSL Certificate Management
            </h4>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Certificate Status</label>
                    <div id="ssl-status" class="text-sm text-gray-600 p-3 bg-gray-50 rounded">
                        Checking...
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-2">
                    <button id="check-ssl-btn" class="btn btn-primary flex-1">
                        <i class="fas fa-search mr-1"></i>Check Status
                    </button>
                    <button id="generate-ssl-btn" class="btn btn-success flex-1" style="display: none;">
                        <i class="fas fa-certificate mr-1"></i>Generate SSL
                    </button>
                    <button id="delete-ssl-btn" class="btn btn-danger flex-1" style="display: none;">
                        <i class="fas fa-trash mr-1"></i>Delete
                    </button>
                </div>

                <!-- SSL Generation Form (hidden by default) -->
                <div id="ssl-form" class="border-t pt-4 mt-4" style="display: none;">
                    <h5 class="text-sm font-medium text-gray-700 mb-3">Generate Self-Signed Certificate</h5>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Common Name</label>
                            <input type="text" id="ssl-common-name" value="localhost"
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Organization</label>
                            <input type="text" id="ssl-organization" value="NDash DNS Server"
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Country Code</label>
                            <input type="text" id="ssl-country" value="US" maxlength="2"
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Validity (days)</label>
                            <input type="number" id="ssl-validity" value="365" min="1" max="3650"
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500">
                        </div>
                    </div>
                    <button onclick="generateSSLCertificate()" class="btn btn-primary w-full mt-3">
                        <i class="fas fa-certificate mr-1"></i>Generate Self-Signed SSL
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load Bind status on page load
document.addEventListener('DOMContentLoaded', function() {
    loadBindStatus();
    
    // Add form submit handlers to show loading state
    const zoneForm = document.querySelector('form[action="/settings"]:first-of-type');
    const resolverForm = document.querySelector('form[action="/settings"]:last-of-type');
    const saveZoneBtn = document.getElementById('save-settings-btn');
    const saveResolverBtn = document.getElementById('save-resolver-btn');
    
    if (zoneForm && saveZoneBtn) {
        zoneForm.addEventListener('submit', function(e) {
            saveZoneBtn.disabled = true;
            saveZoneBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
        });
    }
    
    if (resolverForm && saveResolverBtn) {
        resolverForm.addEventListener('submit', function(e) {
            saveResolverBtn.disabled = true;
            saveResolverBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
        });
    }
    
    // Show current settings state in console
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    console.log('Current Settings State:');
    checkboxes.forEach(cb => {
        console.log(`  ${cb.name}: ${cb.checked ? 'ON' : 'OFF'}`);
    });
});

function loadBindStatus() {
    fetch('/settings/status')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('bind-status');
            if (data.success) {
                const statusColor = data.status === 'running' ? 'green' : 'red';
                const statusIcon = data.status === 'running' ? 'check-circle' : 'times-circle';
                
                statusDiv.innerHTML = `
                    <div class="text-center py-3">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-${statusColor}-100 mb-3">
                            <i class="fas fa-${statusIcon} text-3xl text-${statusColor}-600"></i>
                        </div>
                        <p class="text-lg font-semibold text-gray-800 capitalize">${data.status}</p>
                        <p class="text-xs text-gray-600 mt-1">${data.version}</p>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-exclamation-triangle text-3xl text-yellow-600 mb-2"></i>
                        <p class="text-sm text-gray-600">Failed to load status</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading status:', error);
        });
}

function refreshStatus() {
    const icon = document.getElementById('refresh-icon');
    icon.classList.add('fa-spin');
    loadBindStatus();
    setTimeout(() => icon.classList.remove('fa-spin'), 1000);
}

function reloadBind() {
    fetch('/zones/reload', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(loadBindStatus, 500);
        }
    })
    .catch(error => showNotification('Failed to reload Bind', 'error'));
}

function checkConfig() {
    showNotification('Config check feature coming soon', 'info');
}

function viewLogs() {
    showNotification('Logs viewer feature coming soon', 'info');
}

function showNotification(message, type) {
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
    };
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        info: 'fa-info-circle'
    };
    
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
    notification.innerHTML = `<i class="fas ${icons[type]} mr-2"></i>${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => notification.remove(), 500);
    }, 3000);
}

// SSL Certificate Management
document.addEventListener('DOMContentLoaded', function() {
    const checkSslBtn = document.getElementById('check-ssl-btn');
    const generateSslBtn = document.getElementById('generate-ssl-btn');
    const deleteSslBtn = document.getElementById('delete-ssl-btn');
    const sslStatus = document.getElementById('ssl-status');

    // Check SSL status on page load
    checkSSLStatus();

    // Check SSL status button
    checkSslBtn.addEventListener('click', function() {
        checkSSLStatus();
    });

    // Generate SSL certificate button
    generateSslBtn.addEventListener('click', function() {
        const sslForm = document.getElementById('ssl-form');
        sslForm.style.display = sslForm.style.display === 'none' ? 'block' : 'none';
    });

    // Handle form submission for SSL generation
    const sslFormElement = document.getElementById('ssl-form');
    if (sslFormElement) {
        const generateBtn = sslFormElement.querySelector('button[onclick="generateSSLCertificate()"]');
        if (generateBtn) {
            generateBtn.addEventListener('click', function(e) {
                e.preventDefault();
                generateSSLCertificate();
            });
        }
    }

    // Delete SSL certificates button
    deleteSslBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to delete the SSL certificates? This will disable DoH and DoT services.')) {
            deleteSSLCertificates();
        }
    });

    function checkSSLStatus() {
        sslStatus.textContent = 'Checking...';
        checkSslBtn.disabled = true;

        fetch('/settings/ssl-info')
            .then(response => response.json())
            .then(data => {
                if (data.certExists && data.keyExists) {
                    sslStatus.innerHTML = `
                        <span class="text-green-600 font-medium">✓ Certificates exist</span><br>
                        <span class="text-xs">Subject: ${data.certInfo?.subject || 'Unknown'}</span><br>
                        <span class="text-xs">Valid until: ${data.certInfo?.validTo || 'Unknown'}</span>
                    `;
                    generateSslBtn.style.display = 'none';
                    deleteSslBtn.style.display = 'inline-block';
                } else {
                    sslStatus.innerHTML = `
                        <span class="text-red-600 font-medium">✗ No certificates found</span><br>
                        <span class="text-xs">Generate certificates to enable DoH/DoT</span>
                    `;
                    generateSslBtn.style.display = 'inline-block';
                    deleteSslBtn.style.display = 'none';
                }
            })
            .catch(error => {
                sslStatus.innerHTML = `<span class="text-red-600">Error checking certificates</span>`;
                console.error('SSL status check error:', error);
            })
            .finally(() => {
                checkSslBtn.disabled = false;
            });
    }

    function generateSSLCertificate() {
        const commonName = document.getElementById('ssl-common-name').value;
        const organizationName = document.getElementById('ssl-organization').value;
        const countryCode = document.getElementById('ssl-country').value;
        const validityDays = document.getElementById('ssl-validity').value;

        generateSslBtn.disabled = true;
        generateSslBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Generating...';

        fetch('/settings/generate-ssl', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                commonName: commonName,
                organizationName: organizationName,
                countryCode: countryCode,
                validityDays: validityDays
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('SSL certificates generated successfully!', 'success');
                checkSSLStatus();
            } else {
                showNotification('Failed to generate SSL certificates: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showNotification('Error generating SSL certificates', 'error');
            console.error('SSL generation error:', error);
        })
        .finally(() => {
            generateSslBtn.disabled = false;
            generateSslBtn.innerHTML = '<i class="fas fa-certificate mr-1"></i>Generate Self-Signed SSL';
        });
    }

    function deleteSSLCertificates() {
        deleteSslBtn.disabled = true;
        deleteSslBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Deleting...';

        fetch('/settings/delete-ssl', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                checkSSLStatus();
            } else {
                showNotification('Failed to delete SSL certificates: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showNotification('Error deleting SSL certificates', 'error');
            console.error('SSL deletion error:', error);
        })
        .finally(() => {
            deleteSslBtn.disabled = false;
            deleteSslBtn.innerHTML = '<i class="fas fa-trash mr-1"></i>Delete Certificates';
        });
    }
});
</script>

<%- include('../partials/footer-standalone') %>
